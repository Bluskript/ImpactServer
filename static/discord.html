<!doctype html>
<html lang="en">
  <head>
    <title>Discord verification</title>
    <style>
      .hidden {
        display: none;
      }
    </style>
    <script>
      /* Functions */
      function getProvidedId() {
        // Impact bot gives us a nice, normal, query string
        var query = new URLSearchParams(window.location.search)
        return query.get("discord")
      }

      function getAlreadyMember() {
        // The link in #verify
        var query = new URLSearchParams(window.location.search)
        return query.get("member") === "1"
      }

      function getAuthToken() {
        // discord's implicit grant passes params as a #hash not a ?query, let's make a query object
        // URLSearchParams works on everything except IE: https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams#Browser_compatibility
        var query = new URLSearchParams(window.location.hash)
        return query.get("access_token")
      }

      function getTokenField() {
        return document.getElementById("token")
      }

      function showOrHideStuff() {
        var i, elm, authed, showIfAuthed, hideIfAuthed

        authed = getAuthToken() || getProvidedId()
        showIfAuthed = document.getElementsByClassName("show-if-authenticated")
        hideIfAuthed = document.getElementsByClassName("hide-if-authenticated")

        for (i = 0; i < showIfAuthed.length; i++) {
          elm = showIfAuthed[i]
          if (authed) {
            elm.classList.remove("hidden")
          } else {
            elm.classList.add("hidden")
          }
        }

        for (i = 0; i < hideIfAuthed.length; i++) {
          elm = hideIfAuthed[i]
          if (authed) {
            elm.classList.add("hidden")
          } else {
            elm.classList.remove("hidden")
          }
        }
      }

      function redirectToLogin() {
        var url = "https://discordapp.com/oauth2/authorize?client_id=452934110755684382&redirect_uri=https%3A%2F%2Fimpactclient.net%2Fdiscord.html&response_type=code&scope=identify" + (getAlreadyMember() ? "" : "%20guilds.join") + "&response_type=token"
        try {
          window.location.replace(url)
        } catch (e) {
          window.location = url
        }
      }
    </script>
    <script>
      /*
      * Ok so let's try to redirect before even doing the <body>
      * If this fails, it's ok since we just show them a link.
      */
      if (!getAuthToken() && !getProvidedId()) {
        redirectToLogin()
      }
    </script>
  </head>
  <body>
   <noscript>
     You must have javascript enabled to use this tool
   </noscript>
    <p class="hide-if-authenticated">
      <a href="https://discordapp.com/oauth2/authorize?client_id=452934110755684382&redirect_uri=https%3A%2F%2Fimpactclient.net%2Fdiscord.html&response_type=code&scope=identify%20guilds.join&response_type=token">
        Log in with discord
      </a>
    </p>
    <form class="show-if-authenticated hidden" action="/discordverify" method="post">
      <p>
        Please prove you are not a robot:
      </p>
      <div class="g-recaptcha" data-sitekey="6Lf19NcUAAAAADBY-60OxWuSMgr4XMH3aq1BZYRs"></div>
      <input type="hidden" id="token" name="token">
      <input type="hidden" id="id" name="discord">
      <input type="submit" value="Submit" id="submit">
    </form>

    <!-- Scripts at the end of the <body> is basically kinda like DOM ready -->
    <script src="https://www.google.com/recaptcha/api.js" async></script>
    <script async>
      showOrHideStuff()
      document.getElementById("token").value = getAuthToken()
      document.getElementById("id").value = getProvidedId()
    </script>
  </body>
</html>

