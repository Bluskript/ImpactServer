<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>

    <!-- URLSearchParams is not supported on IE, but the URL polyfill should work on IE8+ -->
    <script crossorigin="anonymous" src="https://polyfill.io/v3/polyfill.min.js?features=es5%2CURL%2Chtml5shiv%2CElement.prototype.classList"></script>

    <!-- RegExp.escape() is used by the "confirm password" field -->
    <script crossorigin="anonymous" src="https://raw.githubusercontent.com/benjamingr/RegExp.escape/master/polyfill.js"></script>

    <script>
        /* Functions */
        function getToken() {
            var query = new URLSearchParams(window.location.search)
            return query.get("token")
        }

        function gtag() {
            if (!window.dataLayer) {
                window.dataLayer = []
            }
            window.dataLayer.push(arguments)
        }
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143397381-1"></script>
    <script>
        gtag('js', new Date());
        gtag('config', 'UA-143397381-1');

        var getOutboundLink = function (label) {
            gtag('event', 'click', {
                'event_category': 'outbound',
                'event_label': label,
                'transport_type': 'beacon'
            });
        }
    </script>

    <!-- CSS  -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/min/style-min.css"/>
</head>
<body>
<header>
    <div class="navbar-fixed">
        <nav role="navigation">
            <div class="nav-wrapper container">
                <a href="/" class="brand-logo"><h1>Impact</h1></a>
            </div>
        </nav>
    </div>
</header>

<noscript>This page requires javascript to function</noscript>

<!-- hidden to prevent FOUC, unhidden by JS -->
<div class="container hidden unhide">
    <div class="row">
        <!-- TODO also validate onsubmit for browsers without html5 validation -->
        <form class="col s12" method="post" action="https://api.impactclient.net/v1/register/token">
            <div class="row">
                <div class="input-field col s12" id="token_field">
                    <input type="text" name="token" id="token" class="validate" required pattern="[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}">
                    <label for="token" data-error="Invalid token">
                        Impact account token
                    </label>
                    <span class="helper-text">
                        Impact Accounts require a token generated when you donated
                    </span>
                </div>
                <div class="input-field col s12 m4 l6">
                    <input type="email" name="email" id="email" class="validate" required/>
                    <label for="email">
                        Email
                    </label>
                    <span class="helper-text">
                        This will be used once Impact Account dashboards go live
                    </span>
                </div>
                <div class="input-field col s6 m4 l3">
                    <!--
                        regex requires at least one number, lowercase, uppercase and symbol using lookaheads like /(?=.*[0-9])/
                        It also requires a length of at least 6 using normal pattern matching /.{6,}/
                    -->
                    <input type="password" name="password" id="password" class="validate" required pattern="(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[^a-zA-Z0-9]).{6,}" onchange="form.password2.pattern = RegExp.escape(this.value);"/>
                    <label for="password">
                        Password
                    </label>
                    <span class="helper-text" data-error="Must be 6 characters or more & include lowercase, uppercase, numeric and symbolic characters"></span>
                </div>
                <div class="input-field col s6 m4 l3">
                    <input type="password" name="password2" id="password2" class="validate" required pattern="\w"/>
                    <label for="password2">
                        Confirm
                    </label>
                    <span class="helper-text" data-error="Password does not match"></span>
                </div>
                <div class="input-field col s12">
                    <!-- TODO OAuth button -->
                    <input type="text" name="discord" id="discord" class="validate" required pattern="[0-9]+"/>
                    <label for="discord">
                        Discord ID
                    </label>
                    <span class="helper-text" data-error="Invalid Discord ID">
                        Your discord ID, not your @username#1234 tag.
                        <i style="color: rgba(0,0,0,0.54)">
                            <br>If you don't know it, you can <b>DM Discord Bot to find out</b>
                            <br>You must be <strong>a member of our Discord server</strong> before submitting this form!
                        </i>
                    </span>
                </div>
                <div class="input-field col s12">
                    <!--
                        TODO use MineTools API to get UUID
                        Mojang's API can't be used client-side because of their CORS policy
                        https://api.minetools.eu/uuid
                    -->
                    <input type="text" name="mcuuid" id="minecraft" class="validate" required pattern="[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}"/>
                    <label for="minecraft">
                        Minecraft UUID
                    </label>
                    <span class="helper-text" data-error="Invalid UUID">
                        Your Minecraft UUID, not your username.
                        <i style="color: rgba(0,0,0,0.54)">
                            <br>You can get it from <b>namemc.com</b>
                        </i>
                    </span>
                </div>
                <div class="input-field col s12">
                    <button class="btn waves-effect waves-light" type="submit" name="action">
                        Submit
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>
<script>
    (function () {
        var token = getToken()
        if (token) {
            // Hide the label and set the input value if a token was passed in
            // We don't care if it is valid at this point
            document.getElementById("token_field").classList.add("hidden")
            var tokenField = document.getElementById("token")
            tokenField.value = token
            tokenField.type = "hidden"
        }

        // un-hide stuff tagged with `unhide` to prevent FOUC
        var unhide = document.getElementsByClassName("unhide")
        for (var i = 0; i < unhide.length; i++) {
            var elm = unhide[i]
            elm.classList.remove("unhide")
            elm.classList.remove("hidden")
        }
    })()
</script>
</body>
</html>
