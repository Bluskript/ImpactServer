<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>

    <!-- URLSearchParams is not supported on IE, but the URL polyfill should work on IE8+ -->
    <script crossorigin="anonymous" src="https://polyfill.io/v3/polyfill.min.js?features=es5%2CURL%2Chtml5shiv%2CElement.prototype.classList"></script>

    <!-- jquery used for cross browser ajax, TODO lightweight alternative or just don't ajax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script>
        /* Functions */
        function getToken() {
            var query = new URLSearchParams(window.location.search)
            return query.get("token")
        }

        // TODO just have a form that with action=api/v1 method=post instead of this handler
        function onSubmit() {
            var discord = document.getElementById("discord").value;
            var mcuuid = document.getElementById("mcuuid").value;
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;

            $.post("https://api.impactclient.net/v1/register/token", {
                token: token,
                discord: discord,
                mcuuid: mcuuid,
                email: email,
                password: password
            }).done(function (data) {
                document.getElementById("response_from_server_goes_here").innerHTML = data;
            }).fail(function (data) {
                // TODO don't block non-token requests; the user might enter a token manually
                document.getElementById("response_from_server_goes_here").innerHTML = data.responseText;
            });
        }

        function gtag() {
            if (!window.dataLayer) {
                window.dataLayer = []
            }
            window.dataLayer.push(arguments)
        }
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143397381-1"></script>
    <script>
        gtag('js', new Date());
        gtag('config', 'UA-143397381-1');

        var getOutboundLink = function (label) {
            gtag('event', 'click', {
                'event_category': 'outbound',
                'event_label': label,
                'transport_type': 'beacon'
            });
        }
    </script>

    <!-- CSS  -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/min/style-min.css"/>
</head>
<body>
<div id="hide_this_if_the_token_is_valid">
    Checking token...
</div>
<div class="hidden" id="show_this_if_the_token_is_valid">
    <!-- TODO make this a form -->
    <!-- TODO use materializecss -->
    your token is valid!
    <br>
    lets make you an IMPCAT ACCOUNT
    <br><br>
    what is your discord id (its just the numbers, i DONT want your @blah#1234 tag, DONT put that in). you should go and <a href="/discord.html" target="_blank">join our Discord server</a> if you haven't already, before submitting.
    <input type="text" name="discord" id="discord"/>
    <br>
    what is your minecraft uuid (NOT your username) (u can get it from namemc.com) paste it here thanks
    <input type="text" name="mcuuid" id="mcuuid"/>
    <br>
    email
    <input type="text" name="email" id="email"/>
    <br>
    password
    <input type="password" name="password" id="password"/>
    <br>
    <input type="button" onclick="return onSubmit()" value="submit"/>
</div>
<h1 id="response_from_server_goes_here"></h1>

<script>
    var token = getToken()
    if (token) {
        console.log(token);
        $.get("https://api.impactclient.net/v1/checktoken?token=" + token, function (data) {
            if (data === "true") {
                document.getElementById("show_this_if_the_token_is_valid").classList.remove("hidden")
                document.getElementById("hide_this_if_the_token_is_valid").classList.add("hidden")
            }
        }).fail(function () {
            // TODO don't overwrite the body
            document.getElementsByTagName("body")[0].innerHTML = "token invalid"
        });
    } else {
        // TODO don't overwrite the body
        document.getElementsByTagName("body")[0].innerHTML = "token missing"
    }
</script>
</body>
</html>