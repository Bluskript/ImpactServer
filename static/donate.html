<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Donate to impact</title>

    <!-- CSS  -->
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/min/style-min.css"/>

    <style>
        #amount:before {
            content: '$';
        }
        .fineprint {
            font-family: serif;
            font-size: 0.9em;
        }
    </style>

    <!-- Dependencies -->
    <script crossorigin="anonymous" src="https://polyfill.io/v3/polyfill.min.js"></script>
    <script type="text/javascript" src="/min/modernizr-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/api.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143397381-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-143397381-1');
        
      var getOutboundLink = function(label) {
        gtag('event', 'click', {
            'event_category': 'outbound',
            'event_label': label,
            'transport_type': 'beacon'
        });
      }
    </script>
</head>
<body>
<header>
    <div class="navbar-fixed">
        <nav role="navigation">
            <div class="nav-wrapper container">
                <a href="/" class="brand-logo"><h1>Impact</h1></a>
            </div>
        </nav>
    </div>
</header>
 <div class="section container">
     <div class="row">
         <div class="col s12 med_text">
             <p>Thank you for considering donating. Donations of any size are greatly appreciated!</p>
             <p>
                 If you donate <i>$5 or more</i> then you can register an Impact Account. This enables you to receive certain perks including
                 access to <i>nightly builds</i>, <i>in-game perks</i> and an <i>exclusive role</i> in our Discord server.
             </p>
         </div>
         <div class="col s12">
             <p>If you already have an Impact Account you can login <a href="/account">here</a>.</p>
             <p>If you'd like to donate again, you should <a href="#" onclick="if (api.isLoggedIn()) {api.logout(); alert('Logged out successfully')} else {alert('You are already logged out')} return false;">logout</a> first.</p>
             <p>If you have an Impact registration token, you can <a href="/register">register here</a>.</p>
         </div>
         <p class="col s12 fineprint">
             Please note this is not a purchase. Any rewards we offer in return for your donation are at our sole discretion and can be revoked at any time.
             All rewards require you to setup an Impact Account. If your donation qualifies, you will be able to register an Impact Account after donating.
             In-game rewards (including <i>access to nightly builds</i>) require that you to link a genuine Minecraft Account.
             They will only be activate while you are logged into that Minecraft account.
             Access to Discord related rewards require that you to link your Discord account and that you join our Discord server.
         </p>
     </div>
    <form id="donate" class="row">
        <div class="input-field col s12 m4 l3">
            <span class="prefix">$</span>
            <input id="amount" type="number" data-type="currency" min="0.5" step="0.01" value="5"
                   pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
            <label for="amount" class="active">Amount</label>
        </div>
        <div class="range-field col m8 l9 hide-on-small-and-down">
            <input id="amountslider" type="range" min="1" max="100" value="5">
        </div>
        <div class="col s12">
            <div id="paypal-button-container"></div>
        </div>
    </form>
    <div id="confirmation" class="row hidden">
        <p class="col s12">Thank you for donating <span class="order_amount"></span>!</p>
        <p class="col s12 msg hidden"></p>
        <p class="col s12">Your PayPay Order ID is <code class="order_id"></code> and your Order Status is <code class="order_status"></code>.</p>
        <p class="col s12 fade-in invisible info">
            Register an Impact Account to receive your rewards
            <br>
            Your registration token is <code class="token"></code>. <a href="/register">Click here</a> to use it, or if you prefer you can gift it to a friend.
        </p>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=AaIwV_K_wsv1FUcoee2uHxfYptMhWXLVG6wFbdYEFBY2Ub94kM3m-8yzBOdKHMplLIES6BLGVB3yWJ7J"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>
<script>
    // TODO accept local currency?
    var currency = 'USD'; // https://www.currency-iso.org/dam/downloads/lists/list_one.xml
    var currencyInput = document.getElementById('amount');
    var currencySlider = document.getElementById('amountslider');

    currencyInput.addEventListener('input', () => {
        if (currencySlider.value !== currencyInput.value)
            currencySlider.value = currencyInput.value;

    });
    currencySlider.addEventListener('input', () => {
        if (currencyInput.value !== currencySlider.value)
            currencyInput.value = currencySlider.value;

    });

    function localStringToNumber(s) {
        return Number(String(s).replace(/[^0-9.-]+/g, ""));
    }

    function formatNumber(n) {
        // format number 1000000 to 1,234,567
        return n.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    }


    function formatCurrency(input, blur) {
        // appends $ to value, validates decimal side
        // and puts cursor back in right position.

        // get input value
        var input_val = input.val();

        // don't validate empty input
        if (input_val === "") {
            return;
        }

        // original length
        var original_len = input_val.length;

        // initial caret position
        var caret_pos = input.prop("selectionStart");

        // check for decimal
        if (input_val.indexOf(".") >= 0) {

            // get position of first decimal
            // this prevents multiple decimals from
            // being entered
            var decimal_pos = input_val.indexOf(".");

            // split number by decimal point
            var left_side = input_val.substring(0, decimal_pos);
            var right_side = input_val.substring(decimal_pos);

            // add commas to left side of number
            left_side = formatNumber(left_side);

            // validate right side
            right_side = formatNumber(right_side);

            // On blur make sure 2 numbers after decimal
            if (blur === "blur") {
                right_side += "00";
            }

            // Limit decimal to only 2 digits
            right_side = right_side.substring(0, 2);

            // join number by .
            input_val = "$" + left_side + "." + right_side;

        } else {
            // no decimal entered
            // add commas to number
            // remove all non-digits
            input_val = formatNumber(input_val);
            input_val = "$" + input_val;

            // final formatting
            if (blur === "blur") {
                input_val += ".00";
            }
        }

        // send updated string to input
        input.value = input_val;

        // put caret back in the right position
        var updated_len = input_val.length;
        caret_pos = updated_len - original_len + caret_pos;
        input[0].setSelectionRange(caret_pos, caret_pos);
    }

    function qualifiesForPerks() {
        return localStringToNumber(currencyInput.value) >= 5;
    }

    function getAmount(purchase_units) {
        if (!purchase_units || !Array.isArray(purchase_units)) {
            throw new Error("getAmount requires an array of purchase_unit objects")
        }

        var amount = 0;
        purchase_units.forEach(function (unit) {
            if (!unit || typeof unit !== "object") {
                console.error("getAmount contained unrecognised object", unit)
                return
            }

            var unit_amount = unit.amount
            if (!unit_amount || typeof unit_amount !== "object" || unit_amount.currency_code !== "USD" || unit_amount.value || typeof unit_amount.value !== "string") {
                console.error("getAmount contained unrecognised object", unit)
                return
            }

            // This is the only line in this entire thing that does anything, the rest is type-checking!
            amount += parseFloat(unit_amount.value)
        })

        return amount
    }

    function createOrder(data, actions) {
        $("#confirmation").addClass("hidden")
        $("#confirmation .info").addClass("invisible")

        return actions.order.create({
            intent: 'CAPTURE',
            application_context: {
                brand_name: 'Impact',
                shipping_preference: 'NO_SHIPPING'
                // return_url: '',
                // cancel_url: '',
            },
            purchase_units: [
                {
                    amount: {
                        currency_code: currency,
                        value: localStringToNumber(currencyInput.value)
                    }
                }
            ]
        });
    }

    function onApprove(data, actions) {
        var conf = $("#confirmation")
        var info = conf.find(".info")
        var msg = conf.find(".msg")

        console.log("Approved, about to capture", data)

        return actions.order.capture().then(function (details) {
            // Update user-facing strings
            conf.find(".order_id").text(details.id)
            conf.find(".order_amount").text("$" + getAmount(details.purchase_units))
            conf.find(".order_status").text(details.status)

            conf.removeClass("hidden")
            // Send our server the order ID to get a registration token
            return api.confirmPayment(data.orderID)
                .then(function(token) {
                    msg.text("Donation completed successfully.")
                    if (token && typeof token === "string" && /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(token)) {
                        info.find(".token").text(token)
                        info.find("a").attr("href", '/register.html?token=' + encodeURIComponent(token))
                        info.removeClass("invisible")
                    }
                    msg.removeClass("hidden")
                })
                .catch(function (error) {
                    msg.text("Error processing donation: " + error)
                    msg.removeClass("hidden")
                })
        })
        .catch(function (error) {
            msg.text("Error processing donation: " + error)
            msg.removeClass("hidden")
        })
    }

    paypal.Buttons({
        // TODO on failure?
        createOrder: createOrder,
        onApprove: onApprove
    }).render('#paypal-button-container')
</script>
</body>
</html>
